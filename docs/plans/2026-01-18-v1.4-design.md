# CBDcounter v1.4 - Documento de Diseno

**Fecha:** 18 de enero de 2026
**Estado:** Aprobado

---

## Resumen Ejecutivo

La version 1.4 incluye cuatro mejoras principales:
1. Dashboard de estadisticas con metricas avanzadas
2. Toggle CBD/THC para trackear diferentes sustancias
3. Sistema de backup automatico y manual con cifrado
4. CSV mejorado con soporte multi-sustancia

---

## Feature 1: Dashboard de Estadisticas

### Descripcion
Nueva pantalla `DashboardActivity` que reemplaza la actual `StatsActivity` como punto de entrada desde "Stats".

### Layout

```
+-------------------------------------+
|  <- Toolbar: "Estadisticas"    [gear icon]    |
|------------------------------------|
|  +---------+ +---------+           |
|  |  HOY    | | SEMANA  |           |  <- Cards compactas (2x2 grid)
|  |   3     | |   18    |           |
|  +---------+ +---------+           |
|  +---------+ +---------+           |
|  |PROMEDIO | |  RACHA  |           |
|  |  2.5/d  | | 5 dias  |           |
|  +---------+ +---------+           |
|------------------------------------|
|         [chart icon] Grafica principal         |
|  [7d] [14d] [30d]    < 01-07 ene > |
|------------------------------------|
|  [chart icon] Patrones                         |
|  - Dia mas activo: Sabado (4.2 avg)|
|  - Esta semana vs anterior: +15%   |
|  - Mejor dia: 12 ene (6 tomas)     |
|------------------------------------|
|  [  [calendar icon] Ver calendario de emojis  ]  |
+-------------------------------------+
```

### Cards de Resumen
| Card | Descripcion |
|------|-------------|
| Hoy | Contador del dia actual |
| Semana | Suma de los ultimos 7 dias |
| Promedio | Media diaria del ultimo mes |
| Racha | Dias consecutivos con registro |

### Archivos
- `DashboardActivity.kt` (crear)
- `activity_dashboard.xml` (crear)
- `CalendarActivity.kt` (renombrar desde StatsActivity)

---

## Feature 2: Toggle CBD/THC

### Descripcion
Selector en EmojiSettingsActivity para cambiar el modo de la app entre CBD y THC.

### Ubicacion
Arriba de la configuracion de emojis en EmojiSettingsActivity.

### Diseno Visual

```
+-------------------------------------+
|  Tipo de sustancia                  |
|  +-----------+ +-----------+        |
|  |    CBD    | |    THC    |        |
|  |  (verde)  | | (naranja) |        |
|  +-----------+ +-----------+        |
+-------------------------------------+
```

### Cambios segun Modo

| Elemento | Modo CBD | Modo THC |
|----------|----------|----------|
| Label principal | "CBD" | "THC" |
| Pregunta +1 | "Con que esta alinado el CBD?" | "Que estas fumando?" |
| Subtexto +1 | "Etiqueta la toma con vibra 420" | (mismo) |
| Recuadro Weed/Polen | Verde | Naranja/Ambar |
| Busqueda | "CBD" | "THC" o "CBD+THC" |
| CSV header | substance=CBD | substance=THC |

### Colores
- **CBD:** Verde actual (#4CAF50 o similar)
- **THC:** Naranja/Ambar (#FF9800 o similar)

### Almacenamiento
```kotlin
Prefs.substanceType: String // "CBD" o "THC"
```

---

## Feature 3: Sistema de Backup

### Descripcion
Sistema completo de copias de seguridad con opcion automatica y manual.

### Ubicacion
Nueva seccion en EmojiSettingsActivity (considerar renombrar a SettingsActivity).

### Layout

```
+-------------------------------------+
|  COPIA DE SEGURIDAD                 |
|                                     |
|  Backup automatico         [OFF/ON] |
|  +- Frecuencia: [Diario v]          |
|  +- Ultima: 15 ene 2026, 10:30      |
|                                     |
|  [ [save icon] Crear backup ahora ]          |
|  +- Con cifrado AES-256    [ ]      |
|                                     |
|  [ [download icon] Restaurar backup ]            |
|-------------------------------------|
|  Contenido del backup:              |
|  [check] Contadores diarios               |
|  [check] Notas de texto                   |
|  [check] Grabaciones de voz               |
|  [check] Configuracion de emojis          |
|  [check] Preferencias                     |
+-------------------------------------+
```

### Formato de Backup
| Tipo | Extension | Descripcion |
|------|-----------|-------------|
| Sin cifrar | .zip | ZIP estandar con JSON + audios |
| Con cifrado | .cbdbak | ZIP cifrado con AES-256 |

### Ubicacion de Archivos
```
Documents/CBDCounter/backups/cbdcounter_backup_2026-01-18.zip
```

### Contenido del Backup
- `data.json` - Contadores, notas, preferencias
- `audio/` - Carpeta con grabaciones de voz
- `config.json` - Configuracion de emojis y preferencias

### Frecuencias de Backup Automatico
- Diario
- Semanal
- Mensual

### Archivos
- `BackupManager.kt` (crear)
- Modificar EmojiSettingsActivity para incluir UI

---

## Feature 4: CSV Mejorado

### Estructura

```csv
date,substance,count,notes,has_audio
15-01-2026,CBD,3,"[leaf icon] 10:30 (weed) | [chocolate icon] 14:00 (polen)",true
16-01-2026,THC,5,"[leaf icon] 09:00 (sativa) | [leaf icon] 12:30",false
```

### Columnas
| Columna | Tipo | Descripcion |
|---------|------|-------------|
| date | String | Fecha DD-MM-YYYY |
| substance | String | "CBD" o "THC" |
| count | Integer | Numero de tomas |
| notes | String | Notas del dia (escapadas) |
| has_audio | Boolean | Si hay grabacion de voz |

### Compatibilidad de Importacion
El sistema detecta automaticamente el formato de fecha:
1. DD-MM-YYYY (nuevo formato)
2. YYYY-MM-DD (ISO)
3. DD/MM/YYYY (formato antiguo de la app)

### Registros Antiguos
Registros sin campo `substance` se asumen como CBD.

---

## Archivos a Crear/Modificar

| Archivo | Accion |
|---------|--------|
| `DashboardActivity.kt` | Crear |
| `activity_dashboard.xml` | Crear |
| `CalendarActivity.kt` | Renombrar (antes StatsActivity) |
| `activity_calendar.xml` | Renombrar (antes activity_stats) |
| `BackupManager.kt` | Crear |
| `EmojiSettingsActivity.kt` | Modificar (toggle + backup UI) |
| `Prefs.kt` | Anadir preferencias nuevas |
| `MainActivity.kt` | Cambiar navegacion |
| `colors.xml` | Anadir colores naranja/ambar |
| `strings.xml` | Nuevos textos |
| CSV utils | Modificar import/export |

---

## Navegacion

```
MainActivity
    |
    +-> "Stats" -> DashboardActivity
                        |
                        +-> "Ver calendario" -> CalendarActivity
                        |
                        +-> [gear icon] Ajustes -> EmojiSettingsActivity
                                                    |
                                                    +-> Toggle CBD/THC
                                                    +-> Emojis
                                                    +-> Backup
```

---

## Notas de Implementacion

1. **Branch:** Todos los cambios en `v1.4`
2. **Commits:** No commitear hasta aprobacion final
3. **Testing:** Verificacion manual de cada feature
4. **Compatibilidad:** Mantener retrocompatibilidad con datos existentes
